---

- name: ansible-securehost | freeipa-client | retreive masters ip
  setup:
  register: ipamasterssetup
  delegate_facts: true
  delegate_to: "{{ groups[idm_group][0] }}" # TODO concat all masters IPs

- name: ansible-securehost | freeipa-client | debug masters ip
  debug:
    msg: "{{ ipamasterssetup }}"
    verbosity: 2

- name: ansible-securehost | freeipa-client | create resolved.conf.d directory
  become: true
  file:
    state: directory
    dest: '/etc/systemd/resolved.conf.d'
    mode: "0755"

- name: ansible-securehost | freeipa-client | add dns reference in resolv.conf
  template:
    src: dns_servers.conf.j2
    dest: "/etc/systemd/resolved.conf.d/dns_servers.conf"
    owner: root
    group: root
    mode: 0644
  become: true

- name: ansible-securehost | freeipa-client | restarts systemd-resolved
  service:
    name: systemd-resolved
    state: restarted
  changed_when: false
  become: true

- name: ansible-securehost | freeipa-client | Debug idm groups variable
  ansible.builtin.debug:
    msg: "{{ groups[idm_group] }}"
    verbosity: 2

- name: ansible-securehost | freeipa-client | retreive current hostname
  command: "hostname"
  changed_when: False
  register: current_hostname

- name: ansible-securehost | freeipa-client | debug current hostname
  ansible.builtin.debug:
    var: current_hostname

- name: ansible-securehost | freeipa-client | compute client hostname
  ansible.builtin.debug:
    msg: "{{ ns_hostname | default(current_hostname.stdout if current_hostname.stdout.endswith(company_domain) else idm_client_default_domain_prefix + '.' + company_domain) }}"
  register: serverhost

- name: ansible-securehost | freeipa-client | compute ip if preferred_nic is not set
  ansible.builtin.debug:
    msg: "{{ ipamasterssetup.ansible_facts['ansible_' + preferred_nic].ipv4.address if preferred_nic is defined else ipamasterssetup.ansible_facts.ansible_default_ipv4.address | default(ipamasterssetup.ansible_facts.ansible_all_ipv4_addresses[0]) }}"
  register: ipa_master_ip

- name: ansible-securehost | freeipa-client | set hostname to "{{ ns_hostname | default(idm_client_default_domain_prefix + '.' + company_domain) }}"
  ansible.builtin.include_role:
    name: tcharl.ansible_nameserver
  vars:
    ns_hostname: "{{ serverhost.msg }}"
    hostname_reboot: false
    ansible_become: true
    hosts_entries:
      - name: "{{ groups[idm_group][0] | default(idm_server_default_domain_prefix + '.' + company_domain) }}"
        ip: "{{ ipa_master_ip.msg | ansible.netcommon.ipv4 }}"

- name: ansible-securehost | freeipa-client | install freeipa-client
  ansible.builtin.include_role:
    name: freeipa.ansible_freeipa.ipaclient
  vars:
    ipaclients: "{{ groups[idm_client_group] | list }}"
    ipaadmin_principal: "{{ company_realm_principal }}"
    ipaadmin_password: "{{ company_realm_password }}"
    ipaserver_domain: "{{ company_domain }}"
    ipaserver_realm: "{{ company_domain | upper }}"
    ipaclient_servers: "{{ groups[idm_group] | list }}"
    ipaclient_force_join: yes
    ipaclient_hostname: "{{ ns_hostname | default(idm_client_default_domain_prefix + '.' + company_domain) }}"
    ipaclient_ip_addresses: "{{ ipamasterssetup.ansible_facts.ansible_all_ipv4_addresses }}"
#    ipaclient_use_otp: yes
    ipaclient_allow_repair: yes
    ansible_become: true


##### Commands for testing
#### kinit admin
### ipa user-find
### ipa user-add yume --first=yume --last=sensei --email=yume@senzei.io  --shell=/bin/bash --password
